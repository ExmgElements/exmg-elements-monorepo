<link rel="import" href="./bower_components/polymer/polymer.html">
<link rel="import" href="./bower_components/polymer/polymer-element.html">
<link rel="import" href="./bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="./bower_components/paper-card/paper-card.html">
<link rel="import" href="./bower_components/paper-styles/default-theme.html">
<link rel="import" href="./swagger-client/swagger-client.html">

<script>
(() => {
  'use strict';
  /**
   * @customElement
   * @polymer
   */
  class ExmgSwagger20App extends Polymer.Element {
    static get is() { return 'exmg-swagger2-0-app'; }
    static get properties() {
      return {
        resource: {
          type: String,
          value: ''
        },
        method: {
          type: String,
        },
        swaggerUrl: {
          type: String,
          value: '/src/swagger.json',
        },
        serverUrl: {
          type: String,
          notify: true,
        },
        swaggerClient: {
          type: Object,
        },
        error: {
          type: Object,
          notify: true,
        },
        data: {
          type: Object,
          notify: true,
        },
        auto: {
          type: Boolean,
          notify: true,
          value: false,
        }
      };
    }

    constructor() {
      super();

      new SwaggerClient(this.swaggerUrl, { url: this.serverUrl }).then((swaggerClient) => {
        this.swaggerClient = swaggerClient;

        if (this.auto) {
          this.generateRequest();
        }
      });
    }

    generateRequest() {
      if (!this.swaggerClient) {
        return false;
      }

      this.handleCall();
    }

    handleCall() {
      const resource = this._resourceAvailable();
      const method = this._methodAvailable();

      if (resource.error) {
        return this.set('error', resource.error);
      }

      if (method.error) {
        return this.set('error', method.error);
      }

      this.swaggerClient.url = this.serverUrl;
      this.swaggerClient.spec.basePath = '/api';

      this.swaggerClient.apis[resource][method]().then(
        data =>
          this.set('data', data.obj),
        error =>
          this.set('error', error)
      );
    }

    _resourceAvailable() {
      if (!this.resource) {
        return ({ error: 'No resource given' });
      }

      const isAvailable = this.swaggerClient.spec.tags.find(tag => tag.name === this.resource);

      if (isAvailable) {
        return isAvailable.name;
      }

      return ({ error: 'Resource not found: ' + resource });
    }

    _methodAvailable() {
      if (!this.method) {
        return ({ error: 'No method given' });
      }

      const { apis } = this.swaggerClient;

      for (var key in apis[this.resource]) {
        if (this.method === key ) {
          return key;
        }
      }

      return ({ error: 'Method not found: ' + this.method });
    }
  }

  window.customElements.define(ExmgSwagger20App.is, ExmgSwagger20App);
})();
</script>
