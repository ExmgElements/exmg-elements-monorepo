<link rel="import" href="../polymer/polymer-element.html">

<script>
  'use strict';
  {
  /**
  * Data connection Polymer element that connects using a swagger 2.0 schema and a restfull API server.
  *
  * <exmg-data-connection
  *   resource="globalData"
  *   method="get"
  *   server-url="https://backend.winview-dev-feature.playtotv.com/api/"
  *   error="{{error}}"
  *   data="{{data}}"
  *   auto="true"
  * ></exmg-data-connection>
  *
  * @customElement
  * @polymer
  * @group Exmg Core Elements
  * @element exmg-data-connection
  * @demo demo/index.html
  * @memberof Exmg
  * @extends Polymer.Element
  * @summary Custom element to connect to a restfull API layer using a Swagger 2.0 schema
  */
  class DataConnectionElement extends Polymer.Element {
    static get is() { return 'exmg-data-connection'; }
    static get properties() {
      return {
        // TODO: Add documentation for properties
        resource: {
          type: String,
          value: ''
        },
        method: {
          type: String,
        },
        /**
         * lastRequest's response.
         *
         * Note that lastResponse and lastError are set when lastRequest finishes.
         *
         * @type {Object}
         */
        lastResponse: {
          type: Object,
          notify: true,
          readOnly: true
        },

        /**
         * lastRequest's error, if any.
         *
         * @type {Object}
         */
        lastError: {
          type: Object,
          notify: true,
          readOnly: true
        },
        /**
         * If true, automatically performs an Ajax request when either `url` or
         * `params` changes.
         */
        auto: {
          type: Boolean,
          notify: true,
          value: false,
        },
        retryTimerSwaggerClient: {
          type: Number,
          readOnly: true,
          value: 250,
        },
        /**
         * Length of time in milliseconds to debounce multiple automatically generated requests.
         */
        debounceDuration: {
          type: Number,
          readOnly: true,
          value: 0,
        },
        /**
         * The most recent request made.
         */
        lastRequest: {
          type: Object,
          notify: true,
          readOnly: true
        },
        /**
         * By default, exmg-data-connection events do not bubble. Setting this attribute will cause its
         * events to bubble to the window object.
         */
        // TODO: add bubble option in events

        /**
         * Fired when a response is received.
         *
         * @event response
         */

        /**
         * Fired when an error is received.
         *
         * @event error
         */
        bubbles: {
          type: Boolean,
          value: false
        },
        /**
         * True while request is in flight.
         */
        loading: {
          type: Boolean,
          notify: true,
          readOnly: true
        },

        _boundHandleResponse: {
          type: Function,
        }
      };
    }
    static get observers() {
      return [
        '_requestOptionsChanged(resource, method, auto, debounceDuration)'
      ]
    }

    constructor() {
      super();
      this._boundHandleResponse = this._handleResponse.bind(this);
      this._boundHandleError = this._handleError.bind(this);
    }

    /**
     * Performs an AJAX request using the swagger api.
     *
     */
    generateRequest() {
      if(!Exmg.DataConnectionConfig) {
        throw new Error('Data connection config not loaded!');
      }

      const resource = this._resourceAvailable();
      const method = this._methodAvailable();

      if (resource.error) {
        throw new Error(resource.error);
      }

      if (method.error) {
        throw new Error(method.error);
      }

      const request = Exmg.DataConnectionConfig.apis[resource][method]();

      request.then(
        this._boundHandleResponse
      ).catch(
        this._boundHandleError
      );
      this._setLoading(true);

      return request;
    }

    _handleError(error) {
      this._setLastError({error: error});
      this._setLastResponse(null);
      this._setLoading(false);
      this.dispatchEvent(new CustomEvent('error', { bubbles: this.bubbles, composed: true, detail: {error: error} }));
    }

    _handleResponse(response) {
      this._setLastResponse(response);
      this._setLastError(null);
      this._setLoading(false);
      this.dispatchEvent(new CustomEvent('response', { bubbles: this.bubbles, composed: true, detail: response }));
    }

    /**
     * Checks if Resource is available in Swagger 2.0 schema
     *
     */
    _resourceAvailable() {
      if (!this.resource) {
        return ({ error: `No resource given` });
      }

      const isAvailable = Exmg.DataConnectionConfig.spec.tags.find(tag => tag.name === this.resource);

      if (isAvailable) {
        return isAvailable.name;
      }

      return ({ error: `Resource ${this.resource} not found` });
    }

    /**
     * Checks if Method is available in Swagger 2.0 schema
     *
     */
    _methodAvailable() {
      if (!this.method) {
        return ({ error: `No method given` });
      }

      const { apis } = Exmg.DataConnectionConfig;

      for (var key in apis[this.resource]) {
        if (this.method === key ) {
          return key;
        }
      }

      return ({ error: `Method ${this.method} not found` });
    }

    _requestOptionsChanged() {
      this._debouncer = Polymer.Debouncer.debounce(
        this._debouncer,
        Polymer.Async.timeOut.after(this.debounceDuration),
        () => {
          if (!this.method && !this.resource) {
            return null;
          }
          if (this.auto) {
            this.generateRequest();
          }
        });
    }
  }

  window.customElements.define(DataConnectionElement.is, DataConnectionElement);

  /**
   * @namespace Exmg
   */
  window.Exmg = window.Exmg || {};
  Exmg.DataConnectionElement = DataConnectionElement;
}
</script>
