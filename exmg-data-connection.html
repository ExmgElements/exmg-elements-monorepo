<link rel="import" href="./bower_components/polymer/polymer.html">
<link rel="import" href="./bower_components/polymer/polymer-element.html">
<link rel="import" href="./bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="./bower_components/paper-card/paper-card.html">
<link rel="import" href="./bower_components/paper-styles/default-theme.html">
<link rel="import" href="./swagger-client/swagger-client.html">

<script>
{
  'use strict';
  /**
  * Data connection Polymer element that connects using a swagger 2.0 schema and a restfull API server.
  *
  * <exmg-data-connection
  *   resource="globalData"
  *   method="get"
  *   server-url="https://backend.winview-dev-feature.playtotv.com/api/"
  *   error="{{error}}"
  *   data="{{data}}"
  *   auto="true"
  * ></exmg-data-connection>
  *
  * @customElement
  * @polymer
  * @demo //localhost:8081/demo/
  * @memberof Exmg
  * @extends Polymer.Element
  * @summary Custom element to connect to a restfull API layer using a Swagger 2.0 schema
  */

  class DataConnectionElement extends Polymer.Element {
    static get is() { return 'exmg-data-connection'; }
    static get properties() {
      return {
        resource: {
          type: String,
          value: ''
        },
        method: {
          type: String,
        },
        swaggerUrl: {
          type: String,
          value: '/src/swagger.json',
        },
        serverUrl: {
          type: String,
          notify: true,
        },
        swaggerClient: {
          type: Object,
        },
        error: {
          type: Object,
          notify: true,
        },
        data: {
          type: Object,
          notify: true,
        },
        auto: {
          type: Boolean,
          notify: true,
          value: false,
        }
      };
    }

    constructor() {
      super();

      new SwaggerClient(this.swaggerUrl, { url: this.serverUrl }).then((swaggerClient) => {
        this.swaggerClient = swaggerClient;
        this.swaggerClient.url = this.serverUrl;
        this.swaggerClient.spec.basePath = '/api';

        if (this.auto) {
          this.generateRequest();
        }
      });
    }

    /**
     * Handles data call and returns error or data.
     *
     **/

    generateRequest() {
      if (!this.swaggerClient) {
        return false;
      }

      const resource = this._resourceAvailable();
      const method = this._methodAvailable();

      if (resource.error) {
        return this.set('error', resource.error);
      }

      if (method.error) {
        return this.set('error', method.error);
      }

      this.swaggerClient.apis[resource][method]().then(
        data => this.set('data', data.obj),
        error => this.set('error', error));
    }

    /**
     * Checks if Resource is available in Swagger 2.0 schema
     *
     **/

    _resourceAvailable() {
      if (!this.resource) {
        return ({ error: `No resource given` });
      }

      const isAvailable = this.swaggerClient.spec.tags.find(tag => tag.name === this.resource);

      if (isAvailable) {
        return isAvailable.name;
      }

      return ({ error: `Resource ${this.resource} not found` });
    }

    /**
     * Checks if Method is available in Swagger 2.0 schema
     *
     **/

    _methodAvailable() {
      if (!this.method) {
        return ({ error: `No method given` });
      }

      const { apis } = this.swaggerClient;

      for (var key in apis[this.resource]) {
        if (this.method === key ) {
          return key;
        }
      }

      return ({ error: `Method ${this.method} not found` });
    }
  }

  window.customElements.define(DataConnectionElement.is, DataConnectionElement);

  /**
   * @namespace Exmg
   */
  window.Exmg = window.Exmg || {};
  Exmg.DataConnectionElement = DataConnectionElement;
}
</script>
