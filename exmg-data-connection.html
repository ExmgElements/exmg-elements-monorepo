<link rel="import" href="./bower_components/polymer/polymer-element.html">
<link rel="import" href="./swagger-client/swagger-client.html">

<script>
  'use strict';
  {
  /**
  * Data connection Polymer element that connects using a swagger 2.0 schema and a restfull API server.
  *
  * <exmg-data-connection
  *   resource="globalData"
  *   method="get"
  *   server-url="https://backend.winview-dev-feature.playtotv.com/api/"
  *   error="{{error}}"
  *   data="{{data}}"
  *   auto="true"
  * ></exmg-data-connection>
  *
  * @customElement
  * @polymer
  * @group Exmg Core Elements
  * @element exmg-data-connection
  * @demo demo/index.html
  * @memberof Exmg
  * @extends Polymer.Element
  * @summary Custom element to connect to a restfull API layer using a Swagger 2.0 schema
  */
  class DataConnectionElement extends Polymer.Element {
    static get is() { return 'exmg-data-connection'; }
    static get properties() {
      return {
        // TODO: Add documentation for properties
        resource: {
          type: String,
          value: ''
        },
        method: {
          type: String,
        },
        swaggerUrl: {
          type: String,
          value: '/src/swagger.json',
        },
        serverUrl: {
          type: String,
          notify: true,
        },
        swaggerClient: {
          type: Object,
        },
        error: {
          type: Object,
          notify: true,
        },
        data: {
          type: Object,
          notify: true,
        },
        auto: {
          type: Boolean,
          notify: true,
          value: false,
        },
        retryTimerSwaggerClient: {
          type: Number,
          readOnly: true,
          value: 250,
        },
        /**
         * By default, exmg-data-connection events do not bubble. Setting this attribute will cause its
         * events to bubble to the window object.
         */
        // TODO: add bubble option in events
        bubbles: {
          type: Boolean,
          value: false
        },
      };
    }

    constructor() {
      super();

      // TODO: Move api creation outside element and load it in Exmg namespace (once)
      new SwaggerClient(this.swaggerUrl, { url: this.serverUrl }).then((swaggerClient) => {
        this.swaggerClient = swaggerClient;
        this.swaggerClient.url = this.serverUrl;
        this.swaggerClient.spec.basePath = '/api';

        // TODO: Trigger generating request on init and on param change (see at iron-ajax)
        if (this.auto) {
          this.handleRequest();
        }
      });
    }

    /*
      Check if plugin is loaded, if not retry
    */
    generateRequest() {

      // TODO: Add logging of errors and warnings
      if (!this.swaggerClient) {
        return new Promise((resolve) => {
          setTimeout(() => {
            if (this.swaggerClient) {
              resolve(this.handleRequest());
            }
          }, this.retryTimerSwaggerClient);
        });
      }
      this.handleRequest();
    }

    /**
     * Handles data call and returns error or data.
     *
     **/

    handleRequest() {
      const resource = this._resourceAvailable();
      const method = this._methodAvailable();

      if (resource.error) {
        return this.set('error', resource.error);
      }

      if (method.error) {
        return this.set('error', method.error);
      }

      this.swaggerClient.apis[resource][method]().then(
        data => this.set('data', data.obj),
        error => this.set('error', error));

      // TODO: Also throw events on success and error in a similar fashion on iron-ajax
    }

    /**
     * Checks if Resource is available in Swagger 2.0 schema
     *
     **/

    _resourceAvailable() {
      if (!this.resource) {
        return ({ error: `No resource given` });
      }

      const isAvailable = this.swaggerClient.spec.tags.find(tag => tag.name === this.resource);

      if (isAvailable) {
        return isAvailable.name;
      }

      return ({ error: `Resource ${this.resource} not found` });
    }

    /**
     * Checks if Method is available in Swagger 2.0 schema
     *
     **/

    _methodAvailable() {
      if (!this.method) {
        return ({ error: `No method given` });
      }

      const { apis } = this.swaggerClient;

      for (var key in apis[this.resource]) {
        if (this.method === key ) {
          return key;
        }
      }

      return ({ error: `Method ${this.method} not found` });
    }
  }

  window.customElements.define(DataConnectionElement.is, DataConnectionElement);

  /**
   * @namespace Exmg
   */
  window.Exmg = window.Exmg || {};
  Exmg.DataConnectionElement = DataConnectionElement;
}
</script>
