<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="exmg-swagger-client-import.html">

<script>
  'use strict';
  {
    /**
    * Data connection Config - Polymer element that inits swaggerClient through config to access globaly
    *
    **/
    class DataConnectionConfigElement extends Polymer.Element {
      static get is() {
        return 'exmg-swagger-client-config';
      }
      static get properties() {
        return {
          /**
           * The name of your config.
           *
           * You can use this with the `configName` property of other client element
           * in order to use multiple configurations on a page at once.
           * In that case the name is used as a key to lookup the configuration.
           */
          name: {
            type: String,
            value: ''
          },
          /**
           * Url pointing to the deagger 2.0 json file
           */
          swaggerUrl: {
            type: String,
            observer: '_swaggerUrlChanged',
          },

          /**
           * By default the server url from json file will be used. This serverUrl property is optional
           * and can be used as an override.
           */
          serverUrl: {
            type: String,
            observer: '_serverUrlChanged',
          },

          responseInterceptor: Function,
          requestInterceptor: Function,

          auto: {
            type: Boolean,
            value: false,
          }
        };
      }
      _swaggerUrlChanged(url) {
        if (this.auto) {
          this._reset();
          this.initSwagger();
        }
      }
      _serverUrlChanged(url) {
        if (Exmg.swaggerClient && this.serverUrl) {
          Exmg.swaggerClient.url = this.serverUrl;
        }
      }
      _reset() {
        Exmg.swaggerClient = null;
      }
      initSwagger() {
        /* Load swagger api */
        this.swaggerClient = new SwaggerClient(this.swaggerUrl, {
          url: this.serverUrl,
          responseInterceptor: this.responseInterceptor,
          requestInterceptor: this.requestInterceptor
        }).then((swaggerClient) => {
          /* enable cors */
          swaggerClient.http.withCredentials = true;
          swaggerClient.name = this.name;

          /* if server url is different then the one specified in api */
          if (this.serverUrl && this.serverUrl !== swaggerClient.url) {
            swaggerClient.url = this.serverUrl;
          }

          /* Add swagger api to Exmg scope */
          window.Exmg.swaggerClient.addApi(this.name, swaggerClient);

          this.dispatchEvent(new CustomEvent('swagger-api-initialized', {bubbles: true, composed: true, detail: {name: this.name}}));
        });

      }
    }
    window.customElements.define(DataConnectionConfigElement.is, DataConnectionConfigElement);

    /**
     * @namespace Exmg
     */
    window.Exmg = window.Exmg || {};
    Exmg.DataConnectionConfigElement = DataConnectionConfigElement;

    if (!window.Exmg.swaggerClient) {
      class ExmgSwaggerClient {
        constructor() {
          this.apis = {};
        }
        addApi(name, api) {
          this.apis[name] = api;
        }
        api(name) {
          const api = this.apis[name];
          if (!api) {
            throw new Error(`Api ${api} not found`);
          }
          return api;
        }
      }
      window.Exmg.swaggerClient = new ExmgSwaggerClient();
    }

  }
</script>
